# Wellbee システムアーキテクチャ

## 1. アーキテクチャ概要

Wellbeeは、Django REST Frameworkバックエンドと、Flutterマルチプラットフォームフロントエンドから構成される、クライアント・サーバー型のウェルネス管理システムです。

```
┌─────────────────────────────────────────────────────────┐
│                    クライアント層                        │
├─────────────────────────────────────────────────────────┤
│  Flutter App (iOS/Android/Web/Desktop)                  │
│  - Riverpod状態管理                                      │
│  - HTTP通信 (JWT認証)                                    │
│  - UI/UXコンポーネント                                   │
└───────────────────┬─────────────────────────────────────┘
                    │ REST API (JSON/JWT)
                    │
┌───────────────────▼─────────────────────────────────────┐
│                   API Gateway層                          │
├─────────────────────────────────────────────────────────┤
│  Nginx (Reverse Proxy)                                  │
│  - 静的ファイル配信                                       │
│  - リクエストルーティング                                 │
└───────────────────┬─────────────────────────────────────┘
                    │
┌───────────────────▼─────────────────────────────────────┐
│                 アプリケーション層                        │
├─────────────────────────────────────────────────────────┤
│  Django 4.2.14 + REST Framework                         │
│  - JWT認証・認可                                         │
│  - ビジネスロジック                                       │
│  - Signal処理（自動計算）                                │
│  - Gunicorn WSGIサーバー                                 │
└───────────────────┬─────────────────────────────────────┘
                    │
┌───────────────────▼─────────────────────────────────────┐
│                  データベース層                          │
├─────────────────────────────────────────────────────────┤
│  MySQL 8.0                                              │
│  - トランザクション管理                                   │
│  - データ永続化                                          │
└─────────────────────────────────────────────────────────┘
```

---

## 2. プロジェクト構造

```
wellbee/
├── wellbee/                    # Djangoバックエンド
│   ├── manage.py
│   ├── requirements.txt
│   ├── Dockerfile
│   ├── docker-compose.yml
│   ├── wellbee/                # プロジェクト設定
│   │   ├── settings.py
│   │   ├── urls.py
│   │   ├── authentication.py   # カスタム認証
│   │   ├── permissions.py      # 権限管理
│   │   └── wsgi.py
│   ├── accounts/               # ユーザー管理アプリ
│   ├── attendances/            # 出席・メンバーシップ管理
│   ├── questionnaires/         # 健康調査・アンケート
│   ├── reservations/           # 予約システム
│   ├── versions/               # バージョン管理
│   └── nginx/                  # Nginx設定
├── lib/                        # Flutterフロントエンド
│   ├── main.dart
│   ├── screens/                # 画面コンポーネント
│   │   ├── staff/              # スタッフ専用画面
│   │   ├── attendee/           # 参加者管理画面
│   │   ├── membership/         # メンバーシップ画面
│   │   ├── reservation/        # 予約画面
│   │   └── questionnaire/      # アンケート画面
│   └── ui_parts/               # 再利用可能UIパーツ
├── pubspec.yaml                # Flutter依存関係
├── android/                    # Androidプラットフォーム
├── ios/                        # iOSプラットフォーム
├── web/                        # Webプラットフォーム
└── docs/                       # ドキュメント
```

---

## 3. Djangoアプリケーション構成

### 3.1 accounts アプリ

**役割**: ユーザー認証・プロフィール管理

**モデル**:
- `User` (カスタムユーザーモデル)
  - phone_number (主キー、11桁)
  - password (暗号化)
  - points (IntegerField)
  - is_staff, is_active, is_superuser

- `Profile`
  - userProfile (OneToOneField → User)
  - user_name, gender, date_of_birth
  - created_date

**主要エンドポイント**:
- `POST /accounts/create/` - ユーザー登録
- `POST /accounts/staff_login/` - スタッフログイン
- `POST /accounts/api/staff/token/` - スタッフJWT取得
- `GET/POST /accounts/profile/` - プロフィール管理
- `PATCH /accounts/users/{id}/increase_points/` - ポイント増加
- `POST /accounts/password-reset/request/` - パスワードリセット

### 3.2 attendances アプリ

**役割**: 出席管理・メンバーシップ・コース管理

**モデル**:
- `Course` - コース定義（Yoga, Pilates等）
- `Attendee` - 参加者情報
- `Membership` - メンバーシップ（期間、料金、参加回数）
- `Interview` - カウンセリング記録
- `CheckIn` - チェックイン記録

**Signal処理**:
- Membership `pre_save`:
  - 割引後料金自動計算
  - 有効期限自動設定
  - 最大参加回数自動計算
- Membership `post_save`:
  - ユーザーポイント +1
- CheckIn `post_save`:
  - ユーザーポイント +1
  - 予約の出席状態更新

**主要エンドポイント**:
- `GET/POST /attendances/membership/` - メンバーシップCRUD
- `GET/POST /attendances/attendee/` - 参加者管理
- `POST /attendances/checkin/` - チェックイン
- `GET/POST /attendances/course/` - コース管理

### 3.3 questionnaires アプリ

**役割**: 健康調査・メンタルヘルスアンケート

**モデル**:
- `BaseBodySurvey` - 身体測定（身長・体重・BMI）
- `Question` - アンケート問題定義（28問中、実際は20問を使用）
- `SurveyResponse` - アンケート回答（スコア自動計算）

**Signal処理**:
- BaseBodySurvey `pre_save`:
  - BMI自動計算: `weight / (height/100)^2`
- BaseBodySurvey `post_save`:
  - ユーザーポイント +1
  - Attendee.last_survey_date更新
- SurveyResponse `pre_save`:
  - スコア変換・合計スコア自動計算

**アンケートカテゴリー**:
1. Somatic symptoms（身体的症状）
2. Anxiety and insomnia（不安と不眠）
3. Social dysfunction（社会的機能障害）
4. Severe depression（重度の抑鬱）

**主要エンドポイント**:
- `POST /questionnaires/base_body_survey/` - 身体測定記録
- `POST /questionnaires/survey_response/` - アンケート回答

### 3.4 reservations アプリ

**役割**: 予約・スロット管理

**モデル**:
- `Slot` - クラス枠（日付・時刻・定員）
- `Reservation` - 予約

**Signal処理**:
- Reservation `pre_save`:
  - dateをスロットから自動設定
- Reservation `post_save`:
  - Membership.requested_join_times +1
  - Slot.reserved_people +1
  - Slot.is_max更新
- Reservation `post_delete`:
  - Slot.reserved_people -1
  - Slot.is_max更新

**バリデーション**:
- end_time > start_time
- 同一コースの時間重複チェック

**主要エンドポイント**:
- `GET/POST /reservations/slot/` - スロット管理
- `GET/POST /reservations/reservation/` - 予約管理

### 3.5 versions アプリ

**役割**: アプリバージョン管理

**モデル**:
- `Version` - バージョン番号・作成日

---

## 4. 認証・認可アーキテクチャ

### 4.1 JWT認証フロー

```
┌──────────┐                           ┌──────────┐
│  Client  │                           │  Server  │
└─────┬────┘                           └─────┬────┘
      │                                      │
      │ POST /authen/jwt/create/             │
      │ {phone_number, password}             │
      ├─────────────────────────────────────>│
      │                                      │
      │                   ┌──────────────────┤
      │                   │ ユーザー検証      │
      │                   │ パスワードチェック │
      │                   └──────────────────>│
      │                                      │
      │ {access, refresh}                    │
      │<─────────────────────────────────────┤
      │                                      │
      │ GET /attendances/membership/         │
      │ Authorization: JWT {access}          │
      ├─────────────────────────────────────>│
      │                                      │
      │                   ┌──────────────────┤
      │                   │ トークン検証      │
      │                   │ ペイロード抽出    │
      │                   │ 権限チェック      │
      │                   └──────────────────>│
      │                                      │
      │ Response Data                        │
      │<─────────────────────────────────────┤
```

### 4.2 カスタム認証クラス

**QueryParameterJWTAuthentication** ([wellbee/authentication.py](wellbee/wellbee/authentication.py)):

```python
class QueryParameterJWTAuthentication(JWTAuthentication):
    def authenticate(self, request):
        # 1. URLクエリパラメータからトークン取得
        token_from_query = request.query_params.get('token')

        # 2. Authorizationヘッダーからトークン取得
        header = self.get_header(request)
        token_from_header = self.get_raw_token(header)

        # 3. 両方のトークンが一致することを検証
        if token_from_query and token_from_header:
            if token_from_query == token_from_header.decode('utf-8'):
                return super().authenticate(request)

        return None
```

**セキュリティ利点**:
- クエリパラメータとヘッダーの二重検証
- トークン漏洩リスクの軽減

### 4.3 権限管理

**permissions.py** で詳細な権限制御を実装:

| Permission クラス | 適用対象 | ロジック |
|------------------|---------|---------|
| `IsStaffUser` | スタッフ専用 | 認証 + is_staff |
| `BaseUserPermission` | 基本CRUD | list: staff, retrieve/create: 認証, update/destroy: staff |
| `MembershipPermission` | メンバーシップ | 認証ユーザーまたはstaff |
| `CheckInPermission` | チェックイン | create: staff必須 |
| `SlotPermission` | スロット管理 | create/update/destroy: staff |

---

## 5. データベース設計

### 5.1 ER図概要

```
┌─────────────┐
│    User     │
│ (phone_num) │
└──────┬──────┘
       │ 1:1
       ▼
┌─────────────┐
│   Profile   │
│ (user_name) │
└─────────────┘

┌─────────────┐
│    User     │
└──────┬──────┘
       │ 1:N
       ▼
┌─────────────┐      N:1     ┌─────────────┐
│  Attendee   │─────────────>│   Course    │
└──────┬──────┘              └─────────────┘
       │ 1:N
       ▼
┌─────────────┐
│ Membership  │
└──────┬──────┘
       │ 1:N
       ▼
┌─────────────┐      N:1     ┌─────────────┐
│ Reservation │─────────────>│    Slot     │
└──────┬──────┘              └──────┬──────┘
       │ 1:1                        │ N:1
       ▼                            │
┌─────────────┐                     │
│   CheckIn   │                     │
└─────────────┘                     │
                                    ▼
                              ┌─────────────┐
                              │   Course    │
                              └─────────────┘

┌─────────────┐
│  Attendee   │
└──────┬──────┘
       │ 1:N
       ├──────────────────┐
       │                  │
       ▼                  ▼
┌─────────────┐    ┌─────────────┐
│BaseBodySurv │    │SurveyRespon │
└─────────────┘    └─────────────┘
```

### 5.2 主要テーブル定義

#### User テーブル
```sql
CREATE TABLE accounts_user (
    id CHAR(36) PRIMARY KEY,
    phone_number VARCHAR(11) UNIQUE NOT NULL,
    password VARCHAR(128) NOT NULL,
    points INT DEFAULT 0,
    is_staff BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    is_superuser BOOLEAN DEFAULT FALSE
);
```

#### Membership テーブル
```sql
CREATE TABLE attendances_membership (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id CHAR(36) NOT NULL,
    attendee_id INT NOT NULL,
    course VARCHAR(25) NOT NULL,
    times INT NOT NULL,
    num_person INT NOT NULL,
    duration INT NOT NULL,
    offer INT DEFAULT 0,
    minus INT DEFAULT 0,
    discount_rate FLOAT DEFAULT 1.0,
    total_price INT NOT NULL,
    discounted_total_price INT,  -- 自動計算
    max_join_times INT,           -- 自動計算
    requested_join_times INT DEFAULT 0,
    already_join_times INT DEFAULT 0,
    start_day DATE NOT NULL,
    expire_day DATE,              -- 自動計算
    is_expired BOOLEAN DEFAULT FALSE,
    last_check_in DATE,
    request_time DATETIME,
    is_approved BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (user_id) REFERENCES accounts_user(id),
    FOREIGN KEY (attendee_id) REFERENCES attendances_attendee(id),
    FOREIGN KEY (course) REFERENCES attendances_course(course_name)
);
```

#### Slot テーブル
```sql
CREATE TABLE reservations_slot (
    id INT AUTO_INCREMENT PRIMARY KEY,
    course VARCHAR(25) NOT NULL,
    date DATE NOT NULL,
    start_time TIME NOT NULL,
    end_time TIME NOT NULL,
    max_people INT DEFAULT 25,
    reserved_people INT DEFAULT 0,  -- 自動更新
    is_max BOOLEAN DEFAULT FALSE,   -- 自動更新
    is_cancelled BOOLEAN DEFAULT FALSE,
    created_at DATETIME,
    updated_at DATETIME,
    FOREIGN KEY (course) REFERENCES attendances_course(course_name)
);
```

---

## 6. API設計

### 6.1 RESTful設計原則

- **リソースベースURL**: `/attendances/membership/`
- **HTTPメソッド**: GET, POST, PUT, PATCH, DELETE
- **ステータスコード**: 200, 201, 400, 401, 403, 404, 500
- **レスポンス形式**: JSON

### 6.2 エンドポイント一覧

#### 認証関連
```
POST /authen/jwt/create/          # JWT取得
POST /authen/jwt/refresh/         # JWT更新
POST /authen/jwt/verify/          # JWT検証
```

#### ユーザー管理
```
POST /accounts/create/            # ユーザー登録
POST /accounts/staff_login/       # スタッフログイン
GET  /accounts/users/             # ユーザー一覧 (staff)
GET  /accounts/users/{id}/        # ユーザー詳細
PATCH /accounts/users/{id}/increase_points/
POST /accounts/password-reset/request/
```

#### メンバーシップ・出席
```
GET    /attendances/membership/   # 一覧取得
POST   /attendances/membership/   # 作成
GET    /attendances/membership/{id}/
PATCH  /attendances/membership/{id}/
DELETE /attendances/membership/{id}/
POST   /attendances/checkin/      # チェックイン
```

#### 予約
```
GET    /reservations/slot/        # スロット一覧
POST   /reservations/slot/        # スロット作成
GET    /reservations/reservation/ # 予約一覧
POST   /reservations/reservation/ # 予約作成
DELETE /reservations/reservation/{id}/
```

#### 健康調査
```
POST /questionnaires/base_body_survey/
POST /questionnaires/survey_response/
```

### 6.3 リクエスト/レスポンス例

#### メンバーシップ作成

**リクエスト**:
```http
POST /attendances/membership/
Authorization: JWT eyJ0eXAiOiJKV1QiLCJh...
Content-Type: application/json

{
  "user": "uuid-string",
  "attendee": 123,
  "course": "Yoga",
  "duration": 3,
  "times": 2,
  "num_person": 1,
  "total_price": 30000,
  "discount_rate": 0.9,
  "minus": 0,
  "offer": 0,
  "start_day": "2025-01-03"
}
```

**レスポンス**:
```json
{
  "id": 456,
  "user": "uuid-string",
  "attendee": 123,
  "course": "Yoga",
  "duration": 3,
  "times": 2,
  "num_person": 1,
  "total_price": 30000,
  "discounted_total_price": 27000,
  "max_join_times": 24,
  "requested_join_times": 0,
  "already_join_times": 0,
  "start_day": "2025-01-03",
  "expire_day": "2025-04-03",
  "is_expired": false,
  "is_approved": false
}
```

---

## 7. Flutterフロントエンドアーキテクチャ

### 7.1 状態管理（Riverpod）

```
┌──────────────────────────────────────────────┐
│              UI Layer (Widgets)              │
├──────────────────────────────────────────────┤
│  - ConsumerWidget                            │
│  - ref.watch(provider)                       │
└────────────────┬─────────────────────────────┘
                 │
┌────────────────▼─────────────────────────────┐
│         Provider Layer (Riverpod)            │
├──────────────────────────────────────────────┤
│  - StateNotifierProvider                     │
│  - FutureProvider                            │
│  - StreamProvider                            │
└────────────────┬─────────────────────────────┘
                 │
┌────────────────▼─────────────────────────────┐
│         Repository Layer (HTTP)              │
├──────────────────────────────────────────────┤
│  - http package                              │
│  - JWT token管理                             │
│  - SharedPreferences                         │
└────────────────┬─────────────────────────────┘
                 │
┌────────────────▼─────────────────────────────┐
│           Django REST API                    │
└──────────────────────────────────────────────┘
```

### 7.2 画面構成

```
lib/
├── main.dart                    # アプリエントリーポイント
├── screens/
│   ├── sign_up.dart            # ユーザー登録
│   ├── home.dart               # ユーザーホーム
│   ├── attendee/               # 参加者管理
│   │   ├── attendee_add.dart
│   │   ├── attendee_update.dart
│   │   └── attendee.dart
│   ├── membership/             # メンバーシップ
│   ├── reservation/            # 予約
│   ├── questionnaire/          # アンケート
│   ├── graph/                  # グラフ表示
│   └── staff/                  # スタッフ画面
│       ├── auth/
│       ├── staff_home_page.dart
│       ├── course/
│       ├── calendar/
│       ├── qr/
│       └── dm/
└── ui_parts/                   # 再利用UIパーツ
    ├── display.dart
    ├── ticket.dart
    ├── reservation_card.dart
    └── textstyle.dart
```

### 7.3 HTTP通信パターン

```dart
// SharedPreferencesからトークン取得
final prefs = await SharedPreferences.getInstance();
final token = prefs.getString('access_token');

// API呼び出し
final response = await http.get(
  Uri.parse('https://api.wellbee.com/attendances/membership/'),
  headers: {
    'Authorization': 'JWT $token',
    'Content-Type': 'application/json',
  },
);

if (response.statusCode == 200) {
  final data = json.decode(response.body);
  // 状態更新
}
```

---

## 8. インフラ・デプロイメント

### 8.1 Docker構成

**docker-compose.yml**:

```yaml
services:
  app:
    build: .
    container_name: wellbee-docker
    ports:
      - "8000:8000"
    volumes:
      - .:/wellbee
    env_file:
      - .env
    depends_on:
      - db

  web:
    image: nginx:latest
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./static:/static
    depends_on:
      - app

  db:
    image: mysql:8.0
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: ${DATABASE_PASSWORD}
      MYSQL_DATABASE: ${DATABASE_NAME}
    volumes:
      - db_data:/var/lib/mysql

volumes:
  db_data:
```

### 8.2 環境変数管理

**.env**:
```
SECRET_KEY=django-insecure-...
DEBUG=True
ALLOWED_HOSTS=localhost,10.0.2.2,0.0.0.0
DATABASE_ENGINE=django.db.backends.mysql
DATABASE_NAME=wellbee
DATABASE_USER=root
DATABASE_PASSWORD=***
DATABASE_HOST=host.docker.internal
DATABASE_PORT=3306
```

### 8.3 デプロイメントフロー

```
開発環境:
Docker Compose → Django runserver → MySQL

本番環境（想定）:
AWS Fargate → Gunicorn → Nginx → RDS (MySQL)
```

---

## 9. Signal処理アーキテクチャ

### 9.1 Signal一覧

| Model | Signal | 処理内容 |
|-------|--------|---------|
| Membership | pre_save | 割引後料金、有効期限、最大参加回数を自動計算 |
| Membership | post_save | ユーザーポイント +1 |
| CheckIn | post_save | ユーザーポイント +1、予約attended=True |
| Reservation | pre_save | dateをSlotから自動設定 |
| Reservation | post_save | requested_join_times +1, reserved_people +1 |
| Reservation | post_delete | reserved_people -1 |
| BaseBodySurvey | pre_save | BMI自動計算 |
| BaseBodySurvey | post_save | ポイント +1, last_survey_date更新 |
| SurveyResponse | pre_save | スコア計算、合計スコア計算 |

### 9.2 Signal実装例

```python
from django.db.models.signals import pre_save, post_save
from django.dispatch import receiver

@receiver(pre_save, sender=Membership)
def set_discounted_total_price(sender, instance, **kwargs):
    """割引後料金の自動計算"""
    base = instance.total_price - (instance.minus + instance.offer)
    instance.discounted_total_price = int(base * instance.discount_rate)

@receiver(pre_save, sender=Membership)
def set_expire_day(sender, instance, **kwargs):
    """有効期限の自動設定"""
    from dateutil.relativedelta import relativedelta
    instance.expire_day = instance.start_day + relativedelta(
        months=instance.duration
    )

@receiver(post_save, sender=CheckIn)
def increment_points_and_attendance(sender, instance, created, **kwargs):
    """チェックイン時のポイント付与と出席記録"""
    if created:
        # ポイント増加
        user = instance.reservation.membership.user
        user.points += 1
        user.save()

        # 予約を出席済みに
        instance.reservation.attended = True
        instance.reservation.save()
```

---

## 10. セキュリティアーキテクチャ

### 10.1 認証セキュリティ

- **JWT有効期限**: 3年（開発環境）、本番では短縮推奨
- **パスワード暗号化**: Django標準のPBKDF2
- **二重トークン検証**: クエリパラメータ + Authorizationヘッダー

### 10.2 CORS設定

```python
CORS_ALLOWED_ORIGINS = [
    "http://localhost:3000",
    "https://wellbee-studio.com",
]

CORS_ALLOW_CREDENTIALS = True
```

---

## 11. パフォーマンス最適化

### 11.1 データベース最適化

**インデックス**:
- User.phone_number (UNIQUE)
- Slot (course, date, start_time)
- Reservation (membership, slot)

**N+1問題対策** (推奨):
```python
# 悪い例
memberships = Membership.objects.all()
for m in memberships:
    print(m.user.phone_number)  # N+1クエリ

# 良い例
memberships = Membership.objects.select_related('user', 'attendee').all()
```

### 11.2 キャッシング戦略（推奨実装）

```python
# Redis導入例
from django.core.cache import cache

def get_active_slots(course_id):
    cache_key = f'slots_{course_id}'
    slots = cache.get(cache_key)

    if not slots:
        slots = Slot.objects.filter(
            course=course_id,
            is_cancelled=False
        )
        cache.set(cache_key, slots, timeout=300)  # 5分

    return slots
```

---

## 12. スケーラビリティ設計

### 12.1 水平スケーリング

```
                   ┌──────────────┐
                   │ Load Balancer│
                   └───────┬──────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
        ▼                  ▼                  ▼
┌───────────────┐  ┌───────────────┐  ┌───────────────┐
│ App Server 1  │  │ App Server 2  │  │ App Server 3  │
│ (Gunicorn)    │  │ (Gunicorn)    │  │ (Gunicorn)    │
└───────┬───────┘  └───────┬───────┘  └───────┬───────┘
        │                  │                  │
        └──────────────────┼──────────────────┘
                           │
                           ▼
                   ┌──────────────┐
                   │ MySQL (RDS)  │
                   │  Read Replica│
                   └──────────────┘
```

### 12.2 非同期処理（推奨実装）

```python
# Celery + Redis
from celery import shared_task

@shared_task
def send_notification(user_id):
    """通知送信（非同期）"""
    user = User.objects.get(id=user_id)
    # 通知処理
```

---

## 13. モニタリング・ロギング

### 13.1 推奨ツール

- **APM**: New Relic / Datadog
- **ログ集約**: CloudWatch Logs / ELK Stack
- **エラー追跡**: Sentry

### 13.2 ロギング設定

```python
LOGGING = {
    'version': 1,
    'handlers': {
        'file': {
            'level': 'ERROR',
            'class': 'logging.FileHandler',
            'filename': '/var/log/wellbee/error.log',
        },
    },
    'loggers': {
        'django': {
            'handlers': ['file'],
            'level': 'ERROR',
            'propagate': True,
        },
    },
}
```

---

## 14. 今後の拡張性

### 14.1 マイクロサービス化（将来検討）

```
API Gateway
    │
    ├─> User Service (認証・ユーザー管理)
    ├─> Membership Service (メンバーシップ管理)
    ├─> Reservation Service (予約システム)
    ├─> Health Service (健康調査)
    └─> Notification Service (通知)
```

### 14.2 推奨改善項目

1. **キャッシング**: Redis導入
2. **非同期処理**: Celery導入
3. **検索機能**: Elasticsearch導入
4. **リアルタイム通知**: WebSocket (Django Channels)
5. **API Gateway**: Kong / AWS API Gateway
6. **CI/CD**: GitHub Actions → AWS ECS/Fargate

---

## 15. 技術的負債・改善点

### 15.1 現在の課題

- Signal処理が多く、デバッグが困難
- JWT有効期限が長すぎる（3年）
- N+1クエリの最適化が不十分
- テストコードの不足

### 15.2 推奨対策

```python
# Signal → Service層への移行例
class MembershipService:
    @staticmethod
    def create_membership(data):
        # ビジネスロジックを明示的に記述
        membership = Membership(**data)
        membership.discounted_total_price = calculate_discounted_price(
            membership.total_price,
            membership.minus,
            membership.offer,
            membership.discount_rate
        )
        membership.expire_day = calculate_expire_day(
            membership.start_day,
            membership.duration
        )
        membership.save()

        # ポイント付与
        membership.user.increase_points(1)

        return membership
```

---

## 16. アーキテクチャ決定記録（ADR）

### ADR-001: JWT認証の採用

**決定**: JWT（JSON Web Token）をAPIトークンとして採用

**理由**:
- ステートレスな認証機構
- モバイルアプリとの相性が良い
- スケーラビリティ向上

**トレードオフ**:
- トークン失効が困難
- サイズがセッションIDより大きい

### ADR-002: Django Signalの多用

**決定**: pre_save/post_saveシグナルで自動計算を実装

**理由**:
- コード記述量の削減
- モデル変更時の自動処理

**トレードオフ**:
- デバッグが困難
- 処理フローが追いにくい
- **今後の改善**: Service層への移行を推奨

---

## まとめ

Wellbeeのシステムアーキテクチャは、Django REST Framework + Flutterによるモダンなモバイルファーストアーキテクチャです。Signal処理を活用した自動化により開発速度を向上させていますが、今後のスケーラビリティとメンテナンス性向上のためには、Service層の導入、キャッシング、非同期処理の実装が推奨されます。
