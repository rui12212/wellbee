# S3画像保存から表示までの仕組み

**日付**: 2026-01-11
**作業者**: Claude Code

## 概要

Django + django-storages + AWS S3を使った画像保存・配信の仕組みと、FlutterアプリでのS3画像表示までの全体フローを記録。

---

## 1. Django側の設定

### 1.1 settings.py の設定

```python
# wellbee/wellbee/settings.py

# AWS S3 Configuration
AWS_ACCESS_KEY_ID = env('AWS_ACCESS_KEY_ID')
AWS_SECRET_ACCESS_KEY = env('AWS_SECRET_ACCESS_KEY')
AWS_STORAGE_BUCKET_NAME = env('AWS_STORAGE_BUCKET_NAME', default='your-bucket-name')
AWS_S3_REGION_NAME = env('AWS_S3_REGION_NAME', default='your-region')

# ★重要: S3のカスタムドメイン（リージョン指定が必須）
AWS_S3_CUSTOM_DOMAIN = f'{AWS_STORAGE_BUCKET_NAME}.s3.{AWS_S3_REGION_NAME}.amazonaws.com'

# S3のファイルを上書きしない（ファイル名が重複した場合、ランダム文字列を付与）
AWS_S3_FILE_OVERWRITE = False

# クエリパラメータなしのクリーンなURL
AWS_QUERYSTRING_AUTH = False

# デフォルトのストレージバックエンドをS3に設定
DEFAULT_FILE_STORAGE = 'storages.backends.s3boto3.S3Boto3Storage'

# メディアファイルのURL（S3のURL）
MEDIA_URL = f'https://{AWS_S3_CUSTOM_DOMAIN}/'
```

### 1.2 重要なポイント

#### `AWS_S3_CUSTOM_DOMAIN` の役割

**問題**: リージョン指定がないと、デフォルトの`s3.amazonaws.com`エンドポイントが使用され、特定リージョンのバケットにアクセスできない

**エラー例**:
```
https://your-bucket.s3.amazonaws.com/courses/image.png
→ The [region] location constraint is incompatible for the region specific endpoint
```

**解決策**: `AWS_S3_CUSTOM_DOMAIN`を明示的に設定
```python
AWS_S3_CUSTOM_DOMAIN = 'your-bucket.s3.your-region.amazonaws.com'
```

**正しいURL**:
```
https://your-bucket.s3.your-region.amazonaws.com/courses/image.png
```

#### `MEDIA_URL` はS3使用時には無視される

- `MEDIA_URL`は**ローカルファイルストレージ**専用の設定
- S3を使う場合、django-storagesが`AWS_S3_CUSTOM_DOMAIN`を直接使用してURLを生成
- `MEDIA_URL`はS3使用時には参照されない（設定しても影響なし）

---

## 2. 画像保存の流れ（Django管理画面またはAPI経由）

### 2.1 モデル定義

```python
# wellbee/attendances/models.py
class Course(models.Model):
    course_name = models.CharField(max_length=100)
    course_image = models.ImageField(upload_to='courses/', blank=True, null=True)
    is_private = models.BooleanField(default=False)
    is_open = models.BooleanField(default=True)
    is_deleted = models.BooleanField(default=False)
```

### 2.2 画像アップロード時の処理フロー

1. **ファイルアップロード** (Django管理画面、APIなど)
   ```python
   course = Course.objects.create(
       course_name="Yoga",
       course_image=uploaded_file  # InMemoryUploadedFileオブジェクト
   )
   ```

2. **django-storagesが自動処理**
   - `DEFAULT_FILE_STORAGE = 'storages.backends.s3boto3.S3Boto3Storage'`により、S3Boto3Storageが使用される
   - ファイル名が重複する場合、ランダム文字列を付与（`AWS_S3_FILE_OVERWRITE = False`）
   - boto3を使ってS3にアップロード

3. **S3に保存**
   ```
   バケット: your-bucket-name
   リージョン: your-region
   パス: courses/image_randomstring.png
   ```

4. **DBに保存されるパス**
   ```python
   course.course_image.name
   # → 'courses/image_randomstring.png'
   ```

---

## 3. 画像URL生成の仕組み（django-storagesの内部動作）

### 3.1 ImageField.url の動作

```python
# Serializerで使用
obj.course_image.url
```

### 3.2 django-storages内部の処理

```python
# storages/backends/s3boto3.py (簡略版)
class S3Boto3Storage:
    def __init__(self):
        # settings.pyから設定を読み込む
        self.custom_domain = settings.AWS_S3_CUSTOM_DOMAIN
        self.bucket_name = settings.AWS_STORAGE_BUCKET_NAME
        self.region = settings.AWS_S3_REGION_NAME
        # ...

    def url(self, name):
        """
        ファイル名からフルURLを生成
        name: 'courses/image_randomstring.png'
        """
        # AWS_S3_CUSTOM_DOMAINが設定されている場合（優先）
        if self.custom_domain:
            url = f"{self._get_scheme()}://{self.custom_domain}/{name}"
            # 例: https://bucket.s3.region.amazonaws.com/courses/image.png
            return url

        # AWS_S3_CUSTOM_DOMAINがない場合（デフォルト）
        else:
            # boto3でS3エンドポイントURLを生成（リージョン指定なし）
            url = self.connection.meta.client.generate_presigned_url(
                'get_object',
                Params={'Bucket': self.bucket_name, 'Key': name},
                ExpiresIn=0
            )
            # 例: https://bucket.s3.amazonaws.com/courses/image.png
            # ⚠️ 特定リージョンではエラーになる可能性
            return url
```

### 3.3 実際の生成例

**設定あり（正しい）**:
```python
AWS_S3_CUSTOM_DOMAIN = 'bucket.s3.region.amazonaws.com'

obj.course_image.url
# → 'https://bucket.s3.region.amazonaws.com/courses/image.png'
```

**設定なし（問題あり）**:
```python
# AWS_S3_CUSTOM_DOMAINなし

obj.course_image.url
# → 'https://bucket.s3.amazonaws.com/courses/image.png'
# ⚠️ リージョン不一致エラーの可能性
```

### 3.4 MEDIA_URLとの関係

**重要**: `MEDIA_URL`は**S3使用時には完全に無視される**

```python
# settings.py
MEDIA_URL = '/media/'  # ← ローカルストレージ用
DEFAULT_FILE_STORAGE = 'storages.backends.s3boto3.S3Boto3Storage'  # ← S3使用

# この場合、obj.file.url は MEDIA_URL を使わない
# django-storagesが AWS_S3_CUSTOM_DOMAIN を直接使ってURLを生成する
```

**ローカルストレージの場合**:
```python
# settings.py
# DEFAULT_FILE_STORAGE は設定なし（デフォルトのFileSystemStorageを使用）
MEDIA_URL = '/media/'
MEDIA_ROOT = '/path/to/media/'

# この場合、obj.file.url は MEDIA_URL を使う
obj.course_image.url
# → '/media/courses/image.png'
```

---

## 4. Serializer でのURL出力

### 4.1 CourseSerializer

```python
# wellbee/attendances/serializers.py
class CourseSerializer(serializers.ModelSerializer):
    image_url = serializers.SerializerMethodField()

    class Meta:
        model = Course
        fields = ('id', 'course_name', 'is_private', 'is_open', 'course_image', 'image_url')

    def get_image_url(self, obj):
        """S3に保存された画像のフルURLを返す"""
        if obj.course_image:
            # ★ここでdjango-storagesがURLを自動生成
            # AWS_S3_CUSTOM_DOMAIN を使って完全なURLを生成
            return obj.course_image.url
        return None
```

### 4.2 MembershipSerializer

```python
class MembershipSerializer(serializers.ModelSerializer):
    course_image_url = serializers.SerializerMethodField()

    class Meta:
        model = Membership
        fields = (..., 'course_image_url')

    def get_course_image_url(self, obj):
        """コースのS3画像URLを返す"""
        if obj.course and obj.course.course_image:
            return obj.course.course_image.url
        return None
```

### 4.3 ReservationSerializer

```python
class ReservationSerializer(serializers.ModelSerializer):
    slot_course_image_url = serializers.SerializerMethodField()

    class Meta:
        model = Reservation
        fields = (..., 'slot_course_image_url')

    def get_slot_course_image_url(self, obj):
        """予約スロットのコースS3画像URLを返す"""
        if obj.slot and obj.slot.course and obj.slot.course.course_image:
            return obj.slot.course.course_image.url
        return None
```

### 4.4 APIレスポンス例

**Course API**:
```json
{
  "id": 1,
  "course_name": "Yoga",
  "is_private": false,
  "is_open": true,
  "course_image": "courses/image_randomstring.png",
  "image_url": "https://bucket.s3.region.amazonaws.com/courses/image_randomstring.png"
}
```

**Membership API**:
```json
{
  "id": 1,
  "course_name": "Yoga",
  "course_image_url": "https://bucket.s3.region.amazonaws.com/courses/image_randomstring.png",
  ...
}
```

**Reservation API**:
```json
{
  "id": 1,
  "slot_course_name": "Yoga",
  "slot_course_image_url": "https://bucket.s3.region.amazonaws.com/courses/image_randomstring.png",
  ...
}
```

---

## 5. Flutter側での画像表示

### 5.1 グローバルヘルパー関数

```dart
// lib/ui_parts/course_image.dart
Widget buildCourseImage(String? imageUrl, String? courseName) {
  const String fallbackAsset = 'lib/assets/invi_course_pic/female_fitness.png';

  // S3 URLが存在する場合、ネットワーク画像を表示
  if (imageUrl != null && imageUrl.isNotEmpty) {
    return Image.network(
      imageUrl,
      fit: BoxFit.cover,
      errorBuilder: (context, error, stackTrace) {
        // エラー時はfallback画像
        return Image.asset(fallbackAsset, fit: BoxFit.cover);
      },
      loadingBuilder: (context, child, loadingProgress) {
        // ローディング中はプログレスインジケーター
        if (loadingProgress == null) return child;
        return Center(
          child: CircularProgressIndicator(
            value: loadingProgress.expectedTotalBytes != null
                ? loadingProgress.cumulativeBytesLoaded /
                    loadingProgress.expectedTotalBytes!
                : null,
          ),
        );
      },
    );
  }

  // URLがnullまたは空の場合、fallback画像
  return Image.asset(fallbackAsset, fit: BoxFit.cover);
}
```

### 5.2 使用例

**一般ユーザー画面**:
```dart
// lib/ui_parts/ticket.dart - MembershipTicketList
image: buildCourseImage(
  membershipList['course_image_url'],
  membershipList['course_name'],
)

// lib/ui_parts/display.dart - ReservationTicketList
image: buildCourseImage(
  reservationList['slot_course_image_url'],
  reservationList['slot_course_name'],
)
```

**スタッフ画面**:
```dart
// lib/screens/staff/course_add/edit_courses.dart
child: buildCourseImage(imageUrl, name),

// lib/screens/staff/course_add/deleted_courses.dart
child: buildCourseImage(imageUrl, name),
```

---

## 6. 全体フロー図

```
┌─────────────────────────────────────────────────────────────┐
│ 1. 画像アップロード（Django管理画面/API）                      │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. django-storages (S3Boto3Storage)                          │
│    - ファイル名重複チェック（ランダム文字列付与）                │
│    - boto3でS3にアップロード                                  │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. AWS S3                                                    │
│    bucket/courses/image_randomstring.png                    │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ 4. DBに保存                                                  │
│    Course.course_image = "courses/image_randomstring.png"  │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ 5. API呼び出し（Flutter → Django）                           │
│    GET /attendances/course/                                 │
│    GET /attendances/membership/                             │
│    GET /reservations/reservation/                           │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ 6. Serializer処理                                            │
│    obj.course_image.url が呼ばれる                           │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ 7. django-storages URL生成                                   │
│    AWS_S3_CUSTOM_DOMAIN を使用                               │
│    https://bucket.s3.region.amazonaws.com/                  │
│    courses/image_randomstring.png                           │
│    ※MEDIA_URLは使われない                                    │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ 8. JSONレスポンス                                            │
│    { "image_url": "https://..." }                           │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ 9. Flutter - buildCourseImage()                              │
│    - imageUrlがあればImage.network()                         │
│    - なければImage.asset(fallback)                           │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ 10. S3から画像取得 → 画面表示                                 │
│     HTTPリクエストでS3から画像ダウンロード                     │
│     キャッシュ機能により2回目以降は高速                        │
└─────────────────────────────────────────────────────────────┘
```

---

## 7. トラブルシューティング

### 7.1 リージョンエラー

**症状**:
```
The [region] location constraint is incompatible for the region specific endpoint
```

**原因**: `AWS_S3_CUSTOM_DOMAIN`が設定されていない

**確認方法**:
```python
# Serializer内でprintしてURLを確認
print(obj.course_image.url)
# NG: https://bucket.s3.amazonaws.com/courses/xxx.png
# OK: https://bucket.s3.region.amazonaws.com/courses/xxx.png
```

**解決策**:
```python
# settings.py
AWS_S3_CUSTOM_DOMAIN = f'{AWS_STORAGE_BUCKET_NAME}.s3.{AWS_S3_REGION_NAME}.amazonaws.com'
```

サーバー再起動が必要:
```bash
docker restart your-container-name
```

### 7.2 画像がfallbackになる

**確認ポイント**:
1. APIレスポンスで`image_url`が正しく返されているか
2. ブラウザで直接URLを開いて画像が表示されるか
3. S3バケットのパブリックアクセス設定が正しいか
4. Flutter側でネットワークエラーが出ていないか

### 7.3 画像が表示されない

**確認コマンド**:
```bash
# Djangoログを確認
docker logs your-container-name --tail 50

# S3にファイルが存在するか確認
aws s3 ls s3://your-bucket/courses/ --region your-region
```

---

## 8. まとめ

### 重要なポイント

1. **`AWS_S3_CUSTOM_DOMAIN`は必須**
   - リージョン指定のため（特にus-east-1以外のリージョン）
   - django-storagesがこの設定を直接使ってURLを生成

2. **`MEDIA_URL`はS3使用時には無視される**
   - ローカルファイルストレージ専用の設定
   - django-storagesが`AWS_S3_CUSTOM_DOMAIN`を直接使用
   - 設定しても影響はないが、混乱を避けるため理解が重要

3. **`.url`プロパティで自動生成**
   - 手動でURL文字列を組み立てる必要なし
   - django-storagesが自動的に完全なURLを生成

4. **fallback画像で安全性確保**
   - 画像がない場合も表示が崩れない
   - ネットワークエラー時も代替画像を表示

### django-storagesの動作まとめ

| 設定 | 役割 | S3使用時 | ローカル使用時 |
|------|------|----------|---------------|
| `DEFAULT_FILE_STORAGE` | ストレージバックエンド指定 | `storages.backends.s3boto3.S3Boto3Storage` | デフォルト（FileSystemStorage） |
| `AWS_S3_CUSTOM_DOMAIN` | S3のカスタムドメイン | **使用される（必須）** | 無視 |
| `MEDIA_URL` | メディアファイルのURL | **無視される** | 使用される |
| `MEDIA_ROOT` | メディアファイルの保存先 | 無視 | 使用される |

### 変更したファイル一覧

**Django**:
- `wellbee/wellbee/settings.py` - S3設定追加（AWS_S3_CUSTOM_DOMAIN追加）
- `wellbee/attendances/models.py` - ImageField追加
- `wellbee/attendances/serializers.py` - image_url, course_image_url追加
- `wellbee/reservations/serializers.py` - slot_course_image_url追加

**Flutter**:
- `lib/ui_parts/course_image.dart` - グローバルヘルパー関数（新規）
- `lib/ui_parts/ticket.dart` - S3画像対応
- `lib/ui_parts/display.dart` - S3画像対応
- `lib/screens/home.dart` - S3画像対応
- `lib/screens/staff/course_add/edit_courses.dart` - S3画像対応、画像選択機能削除
- `lib/screens/staff/course_add/deleted_courses.dart` - S3画像対応

---

## 参考リンク

- [django-storages Documentation](https://django-storages.readthedocs.io/)
- [boto3 S3 Documentation](https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html)
- [Flutter Image.network](https://api.flutter.dev/flutter/widgets/Image/Image.network.html)
- [AWS S3 Regions](https://docs.aws.amazon.com/general/latest/gr/s3.html)
