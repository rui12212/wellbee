# マイグレーション実行完了

## 作業日時
2026-01-06

## 作業概要
Dockerコンテナ内でCourseモデルの変更に関するマイグレーションを実行し、データベースに`course_image`フィールドを追加、`asset_image_path`フィールドを削除した。

## 実施内容

### 1. マイグレーション状態確認

Dockerコンテナ内でマイグレーション状態を確認：

```bash
docker exec wellbee-docker python manage.py showmigrations attendances
```

**結果**:
```
attendances
 [X] 0001_initial
 [X] 0002_initial
 ...
 [X] 0014_course_asset_image_path
 [X] 0015_course_course_image          ← 新規適用済み
 [X] 0016_remove_course_asset_image_path ← 新規適用済み
```

### 2. マイグレーション内容

#### Migration 0015: course_imageフィールド追加
- **ファイル**: `attendances/migrations/0015_course_course_image.py`
- **操作**: Courseモデルに`course_image` ImageFieldを追加
- **upload_to**: `courses/` (S3バケットのcourses/フォルダ)
- **属性**: `blank=True, null=True`（既存データとの互換性確保）

#### Migration 0016: asset_image_pathフィールド削除
- **ファイル**: `attendances/migrations/0016_remove_course_asset_image_path.py`
- **操作**: Courseモデルから`asset_image_path`フィールドを削除
- **理由**: テスト環境専用フィールドで本番環境では不要

### 3. データベース確認

マイグレーション後のCourseデータを確認：

```bash
docker exec wellbee-docker python manage.py shell -c \
  "from attendances.models import Course; \
   courses = Course.objects.all(); \
   print(f'Courses count: {courses.count()}'); \
   [print(f'- {c.id}: {c.course_name}, image: {c.course_image}') for c in courses]"
```

**結果**:
- 14個のコースが存在
- すべての`course_image`フィールドは空（まだ画像未アップロード）
- マイグレーションは正常に完了

**コース一覧**:
1. Yoga
2. Zumba
3. Pilates
4. Kids Yoga(A)
5. Kids Yoga(B)
6. Kids Yoga KG
7. Kids Zumba
8. Kids Karate
9. Kids Gym(A)
10. Kids Gym(B)
11. Private Yoga@Studio
12. Private Yoga@Home
13. Private Pilates@Studio
14. Private Pilates@Home

### 4. API動作確認

**エンドポイント**: `http://localhost:8000/wellbee_122024/attendances/course/`

CourseSerializerが以下のフィールドを返すことを確認：
- `id`
- `course_name`
- `is_private`
- `is_open`
- `course_image` (ImageField、現在は空)
- `image_url` (SerializerMethodField、画像がある場合S3のフルURLを返す)

**APIレスポンス例**（画像未設定時）:
```json
{
  "id": 1,
  "course_name": "Yoga",
  "is_private": false,
  "is_open": true,
  "course_image": null,
  "image_url": null
}
```

**APIレスポンス例**（画像設定後）:
```json
{
  "id": 1,
  "course_name": "Yoga",
  "is_private": false,
  "is_open": true,
  "course_image": "courses/yoga_abc123.jpg",
  "image_url": "https://s3-wellbee-images.s3.me-south-1.amazonaws.com/courses/yoga_abc123.jpg"
}
```

## Dockerコンテナ構成

**起動中のコンテナ**:
```
NAMES            STATUS          PORTS
web              Up              0.0.0.0:80->80/tcp
wellbee-docker   Up              0.0.0.0:8000->8000/tcp
mysql            Up              3306/tcp, 33060/tcp
```

**データベース接続設定**:
- Dockerコンテナ内: `DATABASE_HOST=host.docker.internal`
- ローカル環境から: `DATABASE_HOST=localhost` (要変更)

## データベーススキーマ変更結果

### Courseテーブル

| カラム名 | 型 | 変更 |
|---------|-----|------|
| `id` | INT | 変更なし |
| `course_name` | VARCHAR(25) | 変更なし |
| `is_private` | BOOLEAN | 変更なし |
| `is_open` | BOOLEAN | 変更なし |
| `asset_image_path` | VARCHAR(255) | ❌ 削除 |
| `course_image` | VARCHAR(100) | ✅ 追加 |

**注**: ImageFieldはデータベースには文字列（ファイルパス）として保存されます。

## 重要なポイント

### ImageFieldの動作
1. **ファイルアップロード時**:
   - Djangoが自動的にS3にアップロード（django-storagesが処理）
   - S3のパス: `courses/ファイル名`
   - DBには相対パス（`courses/yoga.jpg`）を保存

2. **URLアクセス時**:
   - `course.course_image.url` でS3のフルURLを取得
   - 例: `https://s3-wellbee-images.s3.me-south-1.amazonaws.com/courses/yoga.jpg`

3. **SerializerMethodField**:
   - `get_image_url()` メソッドで画像URLを動的に生成
   - 画像がない場合は `null` を返す

### S3設定の確認
- **バケット名**: `s3-wellbee-images`
- **リージョン**: `me-south-1`
- **保存先フォルダ**: `courses/`
- **ファイル上書き**: 無効（`AWS_S3_FILE_OVERWRITE = False`）
- **認証**: 不要（`AWS_QUERYSTRING_AUTH = False`）

## 次のステップ

1. **Django Adminで画像アップロードテスト**
   - Admin画面から1つのコースに画像をアップロード
   - S3に正しく保存されるか確認
   - APIで`image_url`が正しく返されるか確認

2. **既存画像のS3移行**
   - Flutter assetsから画像を取得
   - 管理スクリプトでS3に一括アップロード
   - 各コースの`course_image`フィールドを更新

3. **Flutter側の修正**
   - CourseモデルにS3対応フィールドを追加
   - `Image.asset()` → `Image.network(course.imageUrl)` に変更
   - エラーハンドリング追加

## トラブルシューティング

### 問題: ローカル環境からMySQLに接続できない

**エラー**:
```
Can't connect to MySQL server on 'host.docker.internal'
```

**原因**:
- `.env`の`DATABASE_HOST=host.docker.internal`はDockerコンテナ内専用
- ローカル環境（仮想環境）から実行する場合は`localhost`に変更が必要

**解決方法**:
- Dockerコンテナ内で実行: `docker exec wellbee-docker python manage.py <command>`
- または`.env`を一時的に`DATABASE_HOST=localhost`に変更

## 関連ドキュメント

- [モデル変更とマイグレーション完了](./20260105_モデル変更とマイグレーション完了.md)
- [Django側S3設定完了](./20260105_Django側S3設定完了.md)
- [S3画像移行とImageField導入の設計書](../dev/20260103_S3画像移行とImageField導入.md)

## 変更ファイル

- [wellbee/attendances/models.py](../../wellbee/attendances/models.py) - Courseモデル
- [wellbee/attendances/serializers.py](../../wellbee/attendances/serializers.py) - CourseSerializer
- [wellbee/attendances/migrations/0015_course_course_image.py](../../wellbee/attendances/migrations/0015_course_course_image.py)
- [wellbee/attendances/migrations/0016_remove_course_asset_image_path.py](../../wellbee/attendances/migrations/0016_remove_course_asset_image_path.py)

## 使用したコマンド

```bash
# マイグレーション状態確認
docker exec wellbee-docker python manage.py showmigrations attendances

# データ確認
docker exec wellbee-docker python manage.py shell -c "from attendances.models import Course; courses = Course.objects.all(); print(courses.count())"

# コンテナ状態確認
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

# API動作確認
curl http://localhost:8000/wellbee_122024/attendances/course/
```
