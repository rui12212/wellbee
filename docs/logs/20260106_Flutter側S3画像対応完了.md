# Flutter側S3画像対応完了

## 作業日時
2026-01-06

## 作業概要
Flutterのユーザーホーム画面で、コース画像の表示をローカルAssetからS3のネットワーク画像に切り替えた。

## 実施内容

### 1. 画像表示箇所の特定

`asset_image_path`または`slot_course_asset_image_path`を使用しているファイルを検索：

```bash
grep -r "asset_image_path" lib/**/*.dart
```

**検出されたファイル**:
1. `lib/screens/home.dart` - ユーザーホーム画面（修正対象）
2. `lib/screens/staff/course_add/edit_courses.dart` - スタッフ管理画面
3. `lib/screens/staff/course_add/deleted_courses.dart` - 削除コース管理画面
4. `lib/ui_parts/images.dart` - 画像オプション定義

### 2. ユーザーホーム画面の修正

**ファイル**: `lib/screens/home.dart`

**修正箇所**: Line 486-519

#### 変更前のコード（AssetImage使用）:

```dart
Container(
  width: 130.w,
  height: 110.h,
  decoration: BoxDecoration(
    image: DecorationImage(
      fit: BoxFit.cover,
      image: reservation['slot_course_asset_image_path'] != null &&
              reservation['slot_course_asset_image_path']
                  .toString()
                  .isNotEmpty
          ? AssetImage(reservation['slot_course_asset_image_path'])
          : AssetImage('lib/assets/invi_course_pic/female_fitness.png'),
    ),
  ),
)
```

#### 変更後のコード（Image.network使用）:

```dart
Container(
  width: 130.w,
  height: 110.h,
  child: reservation['slot_course_image_url'] != null &&
          reservation['slot_course_image_url']
              .toString()
              .isNotEmpty
      ? Image.network(
          reservation['slot_course_image_url'],
          fit: BoxFit.cover,
          errorBuilder: (context, error, stackTrace) {
            return Image.asset(
              'lib/assets/invi_course_pic/female_fitness.png',
              fit: BoxFit.cover,
            );
          },
          loadingBuilder: (context, child, loadingProgress) {
            if (loadingProgress == null) return child;
            return Center(
              child: CircularProgressIndicator(
                value: loadingProgress.expectedTotalBytes != null
                    ? loadingProgress.cumulativeBytesLoaded /
                        loadingProgress.expectedTotalBytes!
                    : null,
              ),
            );
          },
        )
      : Image.asset(
          'lib/assets/invi_course_pic/female_fitness.png',
          fit: BoxFit.cover,
        ),
)
```

### 3. 主な変更ポイント

#### フィールド名の変更
- **変更前**: `slot_course_asset_image_path` (ローカルassetパス)
- **変更後**: `slot_course_image_url` (S3のURL)

#### 画像表示方法の変更
- **変更前**: `AssetImage()` - ローカルassetから読み込み
- **変更後**: `Image.network()` - S3からネットワーク経由で読み込み

#### エラーハンドリングの追加

**errorBuilder**:
```dart
errorBuilder: (context, error, stackTrace) {
  return Image.asset(
    'lib/assets/invi_course_pic/female_fitness.png',
    fit: BoxFit.cover,
  );
}
```

- ネットワークエラー時にフォールバック画像を表示
- S3接続失敗時も適切に処理

**loadingBuilder**:
```dart
loadingBuilder: (context, child, loadingProgress) {
  if (loadingProgress == null) return child;
  return Center(
    child: CircularProgressIndicator(
      value: loadingProgress.expectedTotalBytes != null
          ? loadingProgress.cumulativeBytesLoaded /
              loadingProgress.expectedTotalBytes!
          : null,
    ),
  );
}
```

- 画像読み込み中にプログレスインジケータを表示
- ダウンロード進捗を視覚的にフィードバック

### 4. スタッフ管理画面について

**未修正のファイル**:
- `lib/screens/staff/course_add/edit_courses.dart`
- `lib/screens/staff/course_add/deleted_courses.dart`

**理由**:
- これらは管理画面でコース作成・編集時にローカルassetから画像を選択する機能
- S3移行後も一時的にローカルasset選択機能を残す
- 将来的にはS3への直接アップロード機能に置き換え予定

## Django側APIレスポンスの想定

### Reservationエンドポイント

**URL**: `GET /wellbee_122024/reservations/reservation/my_reservations/`

**レスポンス例**:
```json
[
  {
    "id": 1,
    "slot_course_name": "Yoga",
    "slot_course_image_url": "https://s3-wellbee-images.s3.me-south-1.amazonaws.com/courses/yoga_abc123.jpg",
    "slot_start_time": "10:00:00",
    "slot_end_time": "11:00:00",
    "date": "2026-01-10",
    ...
  }
]
```

**重要なフィールド**:
- `slot_course_image_url`: S3画像のフルURL（新規追加想定）
- Django側のSerializerで`image_url`フィールドを`slot_course_image_url`として返す必要あり

## 期待される動作

### 画像が存在する場合
1. S3から画像をダウンロード
2. ダウンロード中はCircularProgressIndicatorを表示
3. ダウンロード完了後、画像を表示

### 画像が存在しない場合
1. `slot_course_image_url`が`null`または空文字
2. フォールバック画像（`female_fitness.png`）を表示

### ネットワークエラーの場合
1. S3への接続失敗
2. errorBuilderが発火
3. フォールバック画像を表示

## 次のステップ

### 1. Django側のSerializer修正（要確認）

Reservation APIで`slot_course_image_url`を返すように修正が必要かもしれません：

```python
# reservations/serializers.py
class ReservationSerializer(serializers.ModelSerializer):
    slot_course_image_url = serializers.SerializerMethodField()

    def get_slot_course_image_url(self, obj):
        if obj.slot and obj.slot.course and obj.slot.course.course_image:
            return obj.slot.course.course_image.url
        return None
```

### 2. 既存画像のS3移行

- Flutter assetsから画像ファイルを取得
- S3にアップロード
- 各コースの`course_image`フィールドを更新

### 3. テスト・検証

- [ ] ローカル環境でFlutterアプリを起動
- [ ] ホーム画面で予約情報を確認
- [ ] S3画像が正しく表示されるか確認
- [ ] ネットワークエラー時のフォールバック動作を確認

## 技術的なメリット

### Image.networkの利点

1. **動的な画像配信**
   - アプリ再ビルド不要で画像変更可能
   - サーバー側で画像を管理

2. **アプリサイズの削減**
   - ローカルassetを削除できる
   - アプリのダウンロードサイズが小さくなる

3. **キャッシング**
   - Flutterが自動的に画像をキャッシュ
   - 2回目以降の表示が高速

4. **柔軟性**
   - 複数の画像サイズを用意可能
   - CDN経由での配信も可能

### エラーハンドリングの利点

1. **ユーザー体験の向上**
   - エラー時も画像が表示される
   - アプリがクラッシュしない

2. **デバッグのしやすさ**
   - errorBuilderでエラーログを出力可能
   - 問題の特定が容易

## 注意点

### パフォーマンス

- 初回読み込み時はネットワーク経由のためAssetImageより遅い
- loadingBuilderでプログレスを表示することでUX改善

### ネットワーク接続

- オフライン時はフォールバック画像が表示される
- Wi-Fi推奨の通知が必要な場合は別途実装

### キャッシュ管理

- Flutterの自動キャッシュに依存
- 明示的なキャッシュクリアが必要な場合は別途実装

## 関連ドキュメント

- [マイグレーション実行完了](./20260106_マイグレーション実行完了.md)
- [モデル変更とマイグレーション完了](./20260105_モデル変更とマイグレーション完了.md)
- [S3画像移行とImageField導入の設計書](../dev/20260103_S3画像移行とImageField導入.md)

## 変更ファイル

- [lib/screens/home.dart](../../lib/screens/home.dart) - Line 486-519を修正

## 使用した技術

### Flutter Widget
- `Image.network()` - ネットワーク画像の表示
- `CircularProgressIndicator()` - 読み込み中インジケータ
- `Image.asset()` - フォールバック画像

### エラーハンドリング
- `errorBuilder` - 画像読み込みエラー時の処理
- `loadingBuilder` - 画像読み込み中の処理

### レスポンシブデザイン
- `flutter_screenutil` - 画面サイズに応じたレイアウト調整
