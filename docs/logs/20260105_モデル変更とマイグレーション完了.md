# モデル変更とマイグレーション完了

## 作業日時
2026-01-05

## 作業概要
CourseモデルにS3画像用の`course_image` ImageFieldを追加し、不要な`asset_image_path`フィールドを削除した。

## 実施内容

### 1. Courseモデルの変更

**変更前**:
```python
class Course(models.Model):
    course_name = models.CharField(...)
    is_private = models.BooleanField(...)
    is_open = models.BooleanField(...)
    asset_image_path = models.CharField(
        verbose_name="asset_image_path",
        max_length=255,
        blank=True,
        null=True,
    )
```

**変更後**:
```python
class Course(models.Model):
    course_name = models.CharField(...)
    is_private = models.BooleanField(...)
    is_open = models.BooleanField(...)
    course_image = models.ImageField(
        verbose_name="course_image",
        upload_to='courses/',  # S3のcourses/フォルダに保存
        blank=True,
        null=True,
    )
```

**変更理由**:
- `asset_image_path`はテスト環境のみで使用されており、本番環境では不要
- ImageFieldを使用することで、Djangoがファイルアップロードを自動管理
- S3へのアップロードがdjango-storagesにより自動的に行われる

### 2. CourseSerializerの更新

**変更前**:
```python
class CourseSerializer(serializers.ModelSerializer):
    asset_image_path = serializers.CharField(
        required=False,
        allow_blank=True,
        allow_null=True
    )
    class Meta:
        model = Course
        fields = ('id', 'course_name', 'is_private', 'is_open', 'asset_image_path')
```

**変更後**:
```python
class CourseSerializer(serializers.ModelSerializer):
    image_url = serializers.SerializerMethodField()

    class Meta:
        model = Course
        fields = ('id', 'course_name', 'is_private', 'is_open', 'course_image', 'image_url')
        extra_kwargs = {
            'id': {'read_only': True},
        }

    def get_image_url(self, obj):
        """S3に保存された画像のフルURLを返す"""
        if obj.course_image:
            return obj.course_image.url
        return None
```

**変更内容**:
- `asset_image_path`フィールドを削除
- `course_image` ImageFieldを追加
- `image_url`メソッドフィールドを追加（S3のフルURLを返す）

**APIレスポンス例**:
```json
{
  "id": 1,
  "course_name": "Yoga",
  "is_private": false,
  "is_open": true,
  "course_image": "courses/yoga_abc123.jpg",
  "image_url": "https://s3-wellbee-images.s3.me-south-1.amazonaws.com/courses/yoga_abc123.jpg"
}
```

### 3. マイグレーションファイル作成

#### マイグレーション 0015: course_imageフィールド追加

```bash
cd wellbee
source ../new_env_wellbee/bin/activate
python manage.py makemigrations attendances
```

**作成されたファイル**: `attendances/migrations/0015_course_course_image.py`

```python
class Migration(migrations.Migration):
    dependencies = [
        ('attendances', '0014_course_asset_image_path'),
    ]

    operations = [
        migrations.AddField(
            model_name='course',
            name='course_image',
            field=models.ImageField(
                blank=True,
                null=True,
                upload_to='courses/',
                verbose_name='course_image'
            ),
        ),
    ]
```

#### マイグレーション 0016: asset_image_pathフィールド削除

```bash
python manage.py makemigrations attendances
```

**作成されたファイル**: `attendances/migrations/0016_remove_course_asset_image_path.py`

```python
class Migration(migrations.Migration):
    dependencies = [
        ('attendances', '0015_course_course_image'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='course',
            name='asset_image_path',
        ),
    ]
```

### 4. マイグレーション実行（未実行）

**注意**: マイグレーションファイルは作成されましたが、DBへの適用はまだ行っていません。
次のステップで、以下のコマンドでマイグレーションを実行する必要があります。

```bash
cd wellbee
source ../new_env_wellbee/bin/activate
python manage.py migrate attendances
```

## データベーススキーマ変更

### Courseテーブル

| カラム名 | 型 | 変更内容 |
|---------|-----|---------|
| `asset_image_path` | VARCHAR(255) | ❌ 削除 |
| `course_image` | VARCHAR(100) | ✅ 追加（ImageFieldはVARCHARとして保存） |

**ImageFieldの保存内容**:
- 実際のファイルはS3に保存される
- DBには相対パス（例: `courses/yoga_abc123.jpg`）が保存される
- フルURLは`image_url`メソッドで生成される

## S3への保存パス

```
s3-wellbee-images/
└── courses/
    ├── yoga_abc123.jpg
    ├── pilates_def456.jpg
    └── meditation_ghi789.jpg
```

**命名規則**:
- `upload_to='courses/'` により、S3バケットの `courses/` フォルダに保存
- ファイル名が重複した場合、ランダム文字列が自動付与される（`AWS_S3_FILE_OVERWRITE = False`）

## API エンドポイントへの影響

### GET /api/courses/

**変更前のレスポンス**:
```json
{
  "id": 1,
  "course_name": "Yoga",
  "is_private": false,
  "is_open": true,
  "asset_image_path": "assets/images/yoga.png"
}
```

**変更後のレスポンス**:
```json
{
  "id": 1,
  "course_name": "Yoga",
  "is_private": false,
  "is_open": true,
  "course_image": "courses/yoga_abc123.jpg",
  "image_url": "https://s3-wellbee-images.s3.me-south-1.amazonaws.com/courses/yoga_abc123.jpg"
}
```

**Flutter側の対応**:
- `asset_image_path`の代わりに`image_url`を使用
- `Image.asset()` → `Image.network(course.imageUrl)` に変更

## 次のステップ

1. **マイグレーション実行**（DBが起動している必要あり）
   ```bash
   python manage.py migrate attendances
   ```

2. **既存画像のS3移行**
   - Flutter assetsから画像を取得
   - S3にアップロード
   - DBの`course_image`フィールドを更新

3. **Django Adminでの動作確認**
   - Admin画面からコース編集
   - 画像アップロード機能の動作確認
   - S3に正しくアップロードされるか確認

4. **Flutter側の修正**
   - CourseモデルのフィールドをS3対応に変更
   - Image.networkで画像を表示

## 変更ファイル一覧

- [wellbee/attendances/models.py](../../wellbee/attendances/models.py) - Courseモデル変更
- [wellbee/attendances/serializers.py](../../wellbee/attendances/serializers.py) - CourseSerializer変更
- [wellbee/attendances/migrations/0015_course_course_image.py](../../wellbee/attendances/migrations/0015_course_course_image.py) - 新規作成
- [wellbee/attendances/migrations/0016_remove_course_asset_image_path.py](../../wellbee/attendances/migrations/0016_remove_course_asset_image_path.py) - 新規作成

## 関連ドキュメント

- [Django側S3設定完了](./20260105_Django側S3設定完了.md)
- [S3画像移行とImageField導入の設計書](../dev/20260103_S3画像移行とImageField導入.md)
- [ライブラリ管理方針](../dev/ライブラリ管理方針.md)

## 使用したコマンド

```bash
# マイグレーションファイル作成
cd wellbee
source ../new_env_wellbee/bin/activate
python manage.py makemigrations attendances

# マイグレーション実行（次のステップ）
python manage.py migrate attendances
```
