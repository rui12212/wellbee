# Flutter一般ユーザー向け画面S3対応完了

## 作業日時
2026-01-06

## 作業概要
Flutter一般ユーザー向け画面で、コース画像の表示を全てローカルAssetからS3のネットワーク画像に切り替えた。

## 実施内容

### 1. 修正対象ファイル

一般ユーザー向けページで画像を表示している以下のファイルを修正：

1. ✅ [lib/screens/home.dart](../../lib/screens/home.dart) - 次回予約表示
2. ✅ [lib/ui_parts/ticket.dart](../../lib/ui_parts/ticket.dart) - メンバーシップチケット表示
3. ✅ [lib/ui_parts/display.dart](../../lib/ui_parts/display.dart) - 予約情報表示

### 2. ticket.dartの修正

#### ヘルパー関数の追加（Line 11-38）

```dart
// Helper function to build course image from URL or fallback to asset
Widget _buildCourseImage(String? imageUrl, String? courseName) {
  const String fallbackAsset = 'lib/assets/invi_course_pic/female_fitness.png';

  if (imageUrl != null && imageUrl.isNotEmpty) {
    return Image.network(
      imageUrl,
      fit: BoxFit.cover,
      errorBuilder: (context, error, stackTrace) {
        return Image.asset(fallbackAsset, fit: BoxFit.cover);
      },
      loadingBuilder: (context, child, loadingProgress) {
        if (loadingProgress == null) return child;
        return Center(
          child: CircularProgressIndicator(
            value: loadingProgress.expectedTotalBytes != null
                ? loadingProgress.cumulativeBytesLoaded /
                    loadingProgress.expectedTotalBytes!
                : null,
          ),
        );
      },
    );
  }

  // Fallback to asset image based on course name (legacy support)
  return Image.asset(fallbackAsset, fit: BoxFit.cover);
}
```

**機能**:
- S3画像URLがある場合：Image.networkで表示、ローディング・エラーハンドリング付き
- S3画像URLがない場合：フォールバック画像を表示

#### 修正したクラス

**1. TicketList（Line 293-304）**

変更前：
```dart
image: membershipList['course_name'] == 'Yoga' ||
        membershipList['course_name'] == 'Kids Yoga(A)' ||
        // ... 50行以上のハードコード
```

変更後：
```dart
image: _buildCourseImage(
  membershipList['course_image_url'],
  membershipList['course_name'],
)
```

**2. MembershipTicketList（Line 525-556）**

同様に、50行以上のハードコードされた画像選択ロジックを`_buildCourseImage()`呼び出しに置き換え。

**3. HealthSurveyTicketList（Line 735-755）**

同様に、ハードコードを`_buildCourseImage()`呼び出しに置き換え。

**削減したコード量**: 約150行のハードコードを削除

### 3. display.dartの修正

#### ヘルパー関数の追加（Line 16-43）

ticket.dartと同じヘルパー関数を追加。

#### 修正したクラス

**1. ReservationTicketList（Line 766-778）**

変更前：
```dart
image: reservationList['slot_course_name'] == 'Yoga' ||
        reservationList['slot_course_name'] == 'Kids Yoga(A)' ||
        // ... 50行以上のハードコード
```

変更後：
```dart
image: _buildCourseImage(
  reservationList['slot_course_image_url'],
  reservationList['slot_course_name'],
)
```

**2. PastReservationTicketList（Line 789-800）**

同様に、ハードコードを`_buildCourseImage()`呼び出しに置き換え。

**削減したコード量**: 約100行のハードコードを削除

### 4. フィールド名の変更

#### Membership API（ticket.dart）

| 変更前 | 変更後 | 説明 |
|--------|--------|------|
| - | `course_image_url` | S3画像のフルURL |

**期待されるAPIレスポンス**:
```json
{
  "course_name": "Yoga",
  "attendee_name": "John Doe",
  "course_image_url": "https://s3-wellbee-images.s3.me-south-1.amazonaws.com/courses/yoga.jpg",
  "expire_day": "2026-12-31",
  "times": 8,
  "max_join_times": 12,
  "already_join_times": 4
}
```

#### Reservation API（display.dart）

| 変更前 | 変更後 | 説明 |
|--------|--------|------|
| - | `slot_course_image_url` | S3画像のフルURL |

**期待されるAPIレスポンス**:
```json
{
  "slot_course_name": "Yoga",
  "slot_course_image_url": "https://s3-wellbee-images.s3.me-south-1.amazonaws.com/courses/yoga.jpg",
  "attendee_name": "John Doe",
  "slot_date": "2026-01-15",
  "slot_start_time": "10:00:00",
  "slot_end_time": "11:00:00"
}
```

## コード品質の改善

### Before（ハードコード）

```dart
// 50行以上の繰り返しコード
image: membershipList['course_name'] == 'Yoga' ||
        membershipList['course_name'] == 'Kids Yoga(A)' ||
        membershipList['course_name'] == 'Kids Yoga(B)' ||
        membershipList['course_name'] == 'Kids Yoga KG'
    ? Image.asset('lib/assets/invi_course_pic/invi_yoga.png')
    : membershipList['course_name'] == 'Dance' ||
            membershipList['course_name'] == 'Kids Zumba' ||
            membershipList['course_name'] == 'Zumba'
        ? Image.asset('lib/assets/invi_course_pic/invi_dance.png')
        : // ... 以下40行以上続く
```

**問題点**:
- コードが非常に長く、可読性が低い
- 新しいコースを追加する際、複数箇所を修正する必要がある
- メンテナンスコストが高い
- ネットワーク画像に対応できない

### After（ヘルパー関数）

```dart
// 3行のクリーンなコード
image: _buildCourseImage(
  membershipList['course_image_url'],
  membershipList['course_name'],
)
```

**改善点**:
- コードが簡潔で可読性が高い
- 画像URLはAPIから動的に取得
- 新しいコースを追加してもコード修正不要
- エラーハンドリングとローディング表示を統一的に実装
- S3画像とフォールバック画像の両方に対応

## 削減したコード量

| ファイル | 削減行数 | 備考 |
|---------|---------|------|
| ticket.dart | 約150行 | 3つのクラスから50行ずつ削除 |
| display.dart | 約100行 | 2つのクラスから50行ずつ削除 |
| **合計** | **約250行** | |

## 動作の流れ

### 画像が存在する場合（正常系）

```
1. APIからcourse_image_urlを取得
   ↓
2. Image.networkでS3から画像をダウンロード
   ↓
3. loadingBuilderでプログレス表示
   ↓
4. ダウンロード完了後、画像を表示
```

### 画像が存在しない場合（フォールバック）

```
1. course_image_urlがnullまたは空
   ↓
2. Image.assetでフォールバック画像を表示
   (female_fitness.png)
```

### ネットワークエラーの場合

```
1. S3への接続失敗
   ↓
2. errorBuilderが発火
   ↓
3. Image.assetでフォールバック画像を表示
```

## Django側の対応が必要な箇所

### 1. Membership Serializer

`attendances/serializers.py`に以下を追加する必要があります：

```python
class MembershipSerializer(serializers.ModelSerializer):
    course_image_url = serializers.SerializerMethodField()

    class Meta:
        model = Membership
        fields = [..., 'course_image_url']

    def get_course_image_url(self, obj):
        if obj.course and obj.course.course_image:
            return obj.course.course_image.url
        return None
```

### 2. Reservation Serializer

`reservations/serializers.py`に以下を追加する必要があります：

```python
class ReservationSerializer(serializers.ModelSerializer):
    slot_course_image_url = serializers.SerializerMethodField()

    class Meta:
        model = Reservation
        fields = [..., 'slot_course_image_url']

    def get_slot_course_image_url(self, obj):
        if obj.slot and obj.slot.course and obj.slot.course.course_image:
            return obj.slot.course.course_image.url
        return None
```

## 技術的なメリット

### 1. パフォーマンス

- **初回**: S3から画像ダウンロード（ネットワーク経由）
- **2回目以降**: Flutterが自動キャッシュ、高速表示

### 2. メンテナンス性

- コースごとの画像マッピングロジックが不要
- APIから画像URLを取得するだけ
- 新しいコース追加時にコード修正不要

### 3. 柔軟性

- 画像変更時、S3にアップロードするだけ
- アプリ再ビルド不要
- 複数の画像サイズを用意可能

### 4. ユーザー体験

- プログレスインジケータで読み込み状態を表示
- エラー時もフォールバック画像を表示
- アプリがクラッシュしない

## 次のステップ

### 1. Django Serializerの修正

- [ ] MembershipSerializerに`course_image_url`追加
- [ ] ReservationSerializerに`slot_course_image_url`追加

### 2. 既存画像のS3移行

- [ ] Flutter assetsから画像ファイルを取得
- [ ] S3にアップロード
- [ ] 各コースの`course_image`フィールドを更新

### 3. テスト・検証

- [ ] ローカル環境でFlutterアプリを起動
- [ ] メンバーシップ画面でS3画像が表示されるか確認
- [ ] 予約画面でS3画像が表示されるか確認
- [ ] ネットワークエラー時のフォールバック動作を確認

## 変更ファイル一覧

- ✅ [lib/screens/home.dart](../../lib/screens/home.dart) - Line 486-519修正済み
- ✅ [lib/ui_parts/ticket.dart](../../lib/ui_parts/ticket.dart) - ヘルパー関数追加、3クラス修正
- ✅ [lib/ui_parts/display.dart](../../lib/ui_parts/display.dart) - ヘルパー関数追加、2クラス修正

## 関連ドキュメント

- [Flutter側S3画像対応完了](./20260106_Flutter側S3画像対応完了.md) - home.dartの修正
- [マイグレーション実行完了](./20260106_マイグレーション実行完了.md)
- [S3画像移行とImageField導入の設計書](../dev/20260103_S3画像移行とImageField導入.md)

## まとめ

一般ユーザー向け画面の全ての画像表示をS3対応に切り替え完了：
- **削減コード**: 約250行のハードコードを削除
- **修正ファイル**: 3ファイル（home.dart, ticket.dart, display.dart）
- **修正クラス**: 6クラス（home、3つのticket、2つのdisplay）
- **改善点**: コードの可読性向上、メンテナンス性向上、動的画像管理が可能に
