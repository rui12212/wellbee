# S3バケット作成とIAM設定 - 作業ログ

**作業日**: 2026年1月3日
**担当者**: 開発チーム
**ステータス**: ✅ 完了

---

## 1. 作業概要

AWS S3バケットの作成とIAMユーザーの設定を完了しました。これにより、Django から S3 に画像をアップロードする準備が整いました。

---

## 2. 実施した作業

### 2.1 S3バケットの作成

**バケット名**: `s3-wellbee-images`
**リージョン**: `me-south-1` (Middle East - Bahrain)

**設定内容**:
- オブジェクト所有者: ACL無効
- パブリックアクセス: ブロック解除（画像を公開するため）
- バケットのバージョニング: 有効化
- デフォルトの暗号化: 有効化（SSE-S3）

### 2.2 バケットポリシーの設定

**目的**: `courses/` フォルダ内の画像へのパブリック読み取りアクセスを許可

**適用したポリシー**:
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "PublicReadGetObject",
            "Effect": "Allow",
            "Principal": "*",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::s3-wellbee-images/courses/*"
        }
    ]
}
```

### 2.3 CORS設定

**目的**: Flutter Web アプリから S3 の画像を読み込めるようにする

**適用したCORS設定**:
```json
[
    {
        "AllowedHeaders": ["*"],
        "AllowedMethods": ["GET", "HEAD"],
        "AllowedOrigins": ["*"],
        "ExposeHeaders": []
    }
]
```

### 2.4 IAMユーザーの作成

**IAMユーザー名**: `wellbee-s3-uploader`

**目的**: Django アプリケーションが S3 にアクセスするための認証情報を提供

**アタッチしたポリシー**: `wellbee-s3-upload-policy`

**ポリシー内容**:
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "s3:PutObject",
                "s3:GetObject",
                "s3:DeleteObject",
                "s3:ListBucket"
            ],
            "Resource": [
                "arn:aws:s3:::s3-wellbee-images",
                "arn:aws:s3:::s3-wellbee-images/*"
            ]
        }
    ]
}
```

**権限の説明**:
- `s3:PutObject`: 画像のアップロード
- `s3:GetObject`: 画像の取得
- `s3:DeleteObject`: 画像の削除
- `s3:ListBucket`: バケット内のオブジェクト一覧取得

### 2.5 アクセスキーの発行

**生成したアクセスキー**:
- アクセスキーID: `AKIA...`
- シークレットアクセスキー: `...`（環境変数ファイルに保存済み）

---

## 3. 環境変数の設定

### 3.1 開発環境（.env）

**ファイルパス**: `wellbee/.env`

**追加した環境変数**:
```bash
# AWS S3
AWS_ACCESS_KEY_ID=AKIA...
AWS_SECRET_ACCESS_KEY=...
AWS_STORAGE_BUCKET_NAME=s3-wellbee-images
AWS_S3_REGION_NAME=me-south-1
```

### 3.2 本番環境（.env.prod）

**ファイルパス**: `wellbee/.env.prod`

**追加した環境変数**（開発環境と同じ内容）:
```bash
# AWS S3
AWS_ACCESS_KEY_ID=AKIA...
AWS_SECRET_ACCESS_KEY=...
AWS_STORAGE_BUCKET_NAME=s3-wellbee-images
AWS_S3_REGION_NAME=me-south-1
```

**重要**: 開発環境と本番環境で同じS3バケットを使用する方針

---

## 4. 確認事項

### 4.1 S3バケット

- [x] バケット名: `s3-wellbee-images`
- [x] リージョン: `me-south-1`
- [x] バケットポリシー設定完了
- [x] CORS設定完了
- [x] バージョニング有効化
- [x] 暗号化有効化

### 4.2 IAMユーザー

- [x] ユーザー名: `wellbee-s3-uploader`
- [x] ポリシーアタッチ完了
- [x] アクセスキー発行完了
- [x] 環境変数ファイルに認証情報追加完了

---

## 5. 生成されるURL形式

画像をS3にアップロードすると、以下の形式のURLが生成されます：

```
https://s3-wellbee-images.s3.me-south-1.amazonaws.com/courses/ファイル名
```

**例**:
```
https://s3-wellbee-images.s3.me-south-1.amazonaws.com/courses/invi_yoga_abc123.png
```

---

## 6. セキュリティ考慮事項

### 6.1 実施済みのセキュリティ対策

- ✅ `.env` と `.env.prod` は `.gitignore` に含まれている（認証情報の漏洩防止）
- ✅ IAMユーザーは最小権限の原則に従っている（S3の特定バケットのみアクセス可能）
- ✅ S3バケットのパブリックアクセスは `courses/` フォルダのみ（全体は非公開）
- ✅ S3バケットの暗号化を有効化

### 6.2 今後の推奨事項

- アクセスキーのローテーション（定期的に更新）
- CloudWatch Logsでアクセスログの監視
- S3バケットのアクセスログ有効化

---

## 7. 次のステップ

次は以下の作業に進みます：

1. **Django側の設定**
   - `django-storages` と `Pillow` のインストール
   - `settings.py` にS3設定追加
   - `INSTALLED_APPS` に `storages` 追加

2. **モデル変更**
   - `Course` モデルに `course_image` (ImageField) 追加
   - マイグレーション実行

3. **既存画像の移行**
   - ローカルアセットからS3への移行スクリプト作成・実行

---

## 8. トラブルシューティング

### 8.1 よくある問題と対処法

**問題**: アクセスキーが動作しない
- **対処**: IAMポリシーが正しくアタッチされているか確認
- **確認方法**: IAMコンソール → ユーザー → wellbee-s3-uploader → アクセス許可タブ

**問題**: 画像がパブリックアクセスできない
- **対処**: バケットポリシーが正しく設定されているか確認
- **確認方法**: S3コンソール → s3-wellbee-images → アクセス許可タブ → バケットポリシー

**問題**: CORS エラーが発生
- **対処**: CORS設定が正しく設定されているか確認
- **確認方法**: S3コンソール → s3-wellbee-images → アクセス許可タブ → CORS

---

## 9. 参考情報

### 9.1 AWS ドキュメント

- S3バケットポリシー: https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucket-policies.html
- S3 CORS設定: https://docs.aws.amazon.com/AmazonS3/latest/userguide/cors.html
- IAMユーザー: https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users.html

### 9.2 関連設計書

- [20260103_S3画像移行とImageField導入.md](../dev/20260103_S3画像移行とImageField導入.md)

---

## 10. 作業完了チェックリスト

- [x] S3バケット作成
- [x] バケットポリシー設定
- [x] CORS設定
- [x] バージョニング有効化
- [x] IAMユーザー作成
- [x] IAMポリシー作成・アタッチ
- [x] アクセスキー発行
- [x] `.env` に認証情報追加
- [x] `.env.prod` に認証情報追加
- [x] 作業ログ作成

---

**作業完了時刻**: 2026年1月3日
**次回作業**: Django側の設定（django-storages導入）
