# Django側S3設定完了

## 作業日時
2026-01-05

## 作業概要
Django側でAWS S3連携に必要なライブラリのインストールと設定を完了した。

## 実施内容

### 1. requirements.txt更新

以下のライブラリを追加：

```txt
django-environ==0.12.0  # 0.11.2から更新（Python 3.9互換性対応）
django-storages==1.14.2  # 新規追加
Pillow==10.0.0          # 新規追加
```

**変更理由**:
- `django-environ`: 0.11.2はPython 2構文を使用しており、Python 3.9で動作しないため0.12.0に更新
- `django-storages`: S3をDjangoのストレージバックエンドとして使用するために追加
- `Pillow`: ImageFieldで画像処理を行うために追加

### 2. 仮想環境へのインストール

```bash
source new_env_wellbee/bin/activate
pip install django-storages==1.14.2 Pillow==10.0.0 boto3==1.35.49
```

**インストール結果**:
- django-storages==1.14.2 ✓
- Pillow==10.0.0 ✓
- boto3==1.35.49 ✓（既存）

### 3. settings.py更新

#### INSTALLED_APPSに追加（Line 30付近）

```python
INSTALLED_APPS = [
    'rest_framework',
    'djoser',
    'corsheaders',
    'storages',  # django-storages for S3
    # ... 他のアプリ
]
```

#### S3設定を追加（Line 197-213）

```python
# AWS S3 Configuration
AWS_ACCESS_KEY_ID = env('AWS_ACCESS_KEY_ID')
AWS_SECRET_ACCESS_KEY = env('AWS_SECRET_ACCESS_KEY')
AWS_STORAGE_BUCKET_NAME = env('AWS_STORAGE_BUCKET_NAME', default='s3-wellbee-images')
AWS_S3_REGION_NAME = env('AWS_S3_REGION_NAME', default='me-south-1')

# S3のファイルを上書きしない（ファイル名が重複した場合、ランダム文字列を付与）
AWS_S3_FILE_OVERWRITE = False

# クエリパラメータなしのクリーンなURL
AWS_QUERYSTRING_AUTH = False

# デフォルトのストレージバックエンドをS3に設定
DEFAULT_FILE_STORAGE = 'storages.backends.s3boto3.S3Boto3Storage'

# メディアファイルのURL（S3のURL）
MEDIA_URL = f'https://{AWS_STORAGE_BUCKET_NAME}.s3.{AWS_S3_REGION_NAME}.amazonaws.com/'
```

### 4. 環境変数設定

`.env` と `.env.prod` に以下を追加済み（前回作業で完了）:

```bash
AWS_ACCESS_KEY_ID=AKIA...
AWS_SECRET_ACCESS_KEY=...
AWS_STORAGE_BUCKET_NAME=s3-wellbee-images
AWS_S3_REGION_NAME=me-south-1
```

### 5. 動作確認

```bash
cd wellbee
source ../new_env_wellbee/bin/activate
python manage.py check
```

**結果**: `System check identified no issues (0 silenced).` ✓

## 発生した問題と解決方法

### 問題1: django-environ構文エラー

**エラー内容**:
```
File "environ.py", line 114
    raise ValueError, "No frame marked with %s." % fname
                    ^
SyntaxError: invalid syntax
```

**原因**:
- requirements.txtに記載されていた `django-environ==0.11.2` がPython 2構文を使用
- Python 3.9.4では動作しない

**解決方法**:
1. requirements.txtを `django-environ==0.12.0` に更新
2. 仮想環境で `pip install -r wellbee/requirements.txt` を実行
3. Django設定が正常に読み込まれることを確認

### 問題2: 仮想環境とrequirements.txtの不整合

**原因**:
- 仮想環境に手動で `pip install` したライブラリがrequirements.txtに記載されていなかった
- または、requirements.txtのバージョンが古いまま残っていた

**解決方法**:
- ライブラリ管理方針を策定（パターンA採用）
- 今後は requirements.txt を先に編集してから `pip install -r` を実行する運用に統一

## 次のステップ

1. **Courseモデルに `course_image` ImageFieldを追加**
   - `upload_to='courses/'` で S3 の courses/ フォルダに保存
   - `blank=True, null=True` で既存データとの互換性を保つ

2. **マイグレーション実行**
   - `python manage.py makemigrations`
   - `python manage.py migrate`

3. **Serializerの更新**
   - CourseSerializer に `course_image` フィールドを追加
   - `image_url` メソッドで画像のフルURLを返す

4. **既存画像のS3移行**
   - Flutter assets から画像を取得
   - S3にアップロード
   - DBの `course_image` フィールドを更新

## 関連ドキュメント

- [S3画像移行とImageField導入の設計書](../dev/20260103_S3画像移行とImageField導入.md)
- [ライブラリ管理方針](../dev/ライブラリ管理方針.md)
- [S3バケット作成とIAM設定](./20260103_S3バケット作成とIAM設定.md)

## 設定ファイルの場所

- Django設定: [wellbee/wellbee/settings.py](../../wellbee/wellbee/settings.py)
- ライブラリ一覧: [wellbee/requirements.txt](../../wellbee/requirements.txt)
- 環境変数: `wellbee/.env`, `wellbee/.env.prod`

## 使用したコマンド

```bash
# 仮想環境のアクティベート
source new_env_wellbee/bin/activate

# ライブラリインストール
pip install django-storages==1.14.2 Pillow==10.0.0

# Django設定チェック
cd wellbee && python manage.py check
```
