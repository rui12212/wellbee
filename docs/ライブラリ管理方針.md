# ライブラリ管理方針

## 作成日
2026-01-05

## 概要
Wellbeeプロジェクトにおけるライブラリ管理の統一方針を定義する。
仮想環境とrequirements.txtの不整合を防ぎ、ローカル・Docker・ECS本番環境で完全に同じライブラリ環境を再現することを目的とする。

## 基本原則

### Single Source of Truth
**requirements.txtを唯一の信頼できる情報源とする**

- requirements.txtが常に正しい状態を保つ
- 仮想環境は requirements.txt から生成する
- 手動で `pip install` した場合は、必ず requirements.txt に反映

## 採用する運用パターン：パターンA

### 新しいライブラリを追加する手順

```bash
# 1. 仮想環境をアクティベート
source new_env_wellbee/bin/activate

# 2. requirements.txtに追記（手動編集）
# wellbee/requirements.txt に以下の形式で追加
# django-storages==1.14.2

# 3. 仮想環境に反映
pip install -r wellbee/requirements.txt

# 4. 動作確認
python wellbee/manage.py check

# 5. Gitにコミット
git add wellbee/requirements.txt
git commit -m "Add django-storages library"
```

### ライブラリをアップデートする手順

```bash
# 1. 仮想環境をアクティベート
source new_env_wellbee/bin/activate

# 2. requirements.txtのバージョンを変更（手動編集）
# 例: django-environ==0.11.2 → django-environ==0.12.0

# 3. 仮想環境に反映
pip install -r wellbee/requirements.txt --upgrade

# 4. 動作確認
python wellbee/manage.py check

# 5. Gitにコミット
git add wellbee/requirements.txt
git commit -m "Update django-environ to 0.12.0"
```

## バージョン固定方針

### 推奨: メジャー・マイナー・パッチを完全固定

```txt
Django==4.2.14
django-storages==1.14.2
Pillow==10.0.0
```

**理由**:
- 本番環境での再現性が最も高い
- 予期しない動作変更を防ぐ
- チーム開発で全員が同じ環境を使える

### 非推奨: バージョン範囲指定

```txt
# ❌ 避けるべき
Django>=4.2,<4.3
django-storages>=1.14
Pillow
```

**理由**:
- マイナーバージョンやパッチバージョンの違いで予期しない不具合が発生する可能性
- チームメンバー間で異なるバージョンがインストールされる

## 環境構成

### ローカル開発環境

```
wellbee/
├── new_env_wellbee/          # 仮想環境（Gitには含めない）
│   └── ...
├── wellbee/
│   ├── requirements.txt      # ← 唯一の信頼できる情報源
│   ├── manage.py
│   └── ...
└── docs/
```

**運用ルール**:
1. 開発開始時は必ず `source new_env_wellbee/bin/activate`
2. `which python` で `/Users/rui/dev/wellbee/new_env_wellbee/bin/python` が表示されることを確認
3. ライブラリ追加時は requirements.txt を先に編集してから `pip install -r`

### Docker環境（本番デプロイ用）

```dockerfile
FROM python:3.9.4-slim

WORKDIR /app

# requirements.txtから依存関係をインストール
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# アプリケーションコードをコピー
COPY . .

CMD ["gunicorn", "wellbee.wsgi:application", "--bind", "0.0.0.0:8000"]
```

**利点**:
- ローカルの仮想環境の状態に依存しない
- requirements.txt から自動的にインストール
- 本番環境（ECS）とローカル環境で完全に同じライブラリバージョンが使用される

## デプロイフロー

```
┌─────────────────────────────────────────┐
│  1. ローカル開発                         │
│     - new_env_wellbee仮想環境で開発      │
│     - requirements.txtに追加             │
│     - pip install -r requirements.txt    │
└─────────────┬───────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│  2. Gitにコミット                        │
│     - requirements.txtをコミット         │
└─────────────┬───────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│  3. Dockerイメージビルド                 │
│     - docker build -t wellbee:latest .   │
│     - requirements.txtから自動インストール│
└─────────────┬───────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│  4. ECSにデプロイ                        │
│     - ECRにイメージをプッシュ            │
│     - ECSタスク定義を更新                │
└─────────────────────────────────────────┘
```

## チェックリスト

### 開発開始時
- [ ] `source new_env_wellbee/bin/activate` で仮想環境をアクティベート
- [ ] `which python` で正しい Python が使われているか確認
- [ ] `pip list` で現在のライブラリ一覧を確認

### ライブラリ追加・更新時
- [ ] `wellbee/requirements.txt` を編集
- [ ] `pip install -r wellbee/requirements.txt` で仮想環境に反映
- [ ] `python wellbee/manage.py check` で動作確認
- [ ] Git にコミット

### デプロイ前
- [ ] `docker build` が成功するか確認
- [ ] Dockerコンテナ内で `python manage.py check` が通るか確認
- [ ] 環境変数（.env.prod）が正しく設定されているか確認

## トラブルシューティング

### 仮想環境とrequirements.txtが不整合になった場合

```bash
# 方法1: 強制再インストール
source new_env_wellbee/bin/activate
pip install -r wellbee/requirements.txt --force-reinstall

# 方法2: 仮想環境を作り直す（より確実）
deactivate
rm -rf new_env_wellbee
python -m venv new_env_wellbee
source new_env_wellbee/bin/activate
pip install -r wellbee/requirements.txt
```

### インポートエラーが発生する場合

```bash
# 1. 仮想環境が有効か確認
which python
# → /Users/rui/dev/wellbee/new_env_wellbee/bin/python が表示されるべき

# 2. ライブラリがインストールされているか確認
pip show <ライブラリ名>

# 3. requirements.txtと仮想環境のバージョンを比較
pip list | grep <ライブラリ名>
cat wellbee/requirements.txt | grep <ライブラリ名>
```

## まとめ

| 項目 | 方針 |
|------|------|
| **信頼できる情報源** | `wellbee/requirements.txt`（バージョン完全固定） |
| **ローカル開発** | 仮想環境（`new_env_wellbee`）を requirements.txt から生成 |
| **本番環境** | Docker イメージを requirements.txt からビルド |
| **運用パターン** | パターンA: requirements.txt を先に編集 → pip install |
| **バージョン管理** | メジャー・マイナー・パッチを完全固定（例: `Django==4.2.14`） |

この方針により、ローカル・Docker・ECS本番環境で完全に同じライブラリ環境が再現でき、予期しない不具合を防ぐことができる。
